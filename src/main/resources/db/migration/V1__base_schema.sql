-- Base schema for OPIS HeatMap MVP

CREATE TABLE IF NOT EXISTS station (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    code VARCHAR(64) NOT NULL UNIQUE,
    name VARCHAR(255) NOT NULL,
    state VARCHAR(64) NOT NULL,
    latitude DECIMAL(9,6) NOT NULL,
    longitude DECIMAL(9,6) NOT NULL
);

CREATE TABLE IF NOT EXISTS product (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    code VARCHAR(64) NOT NULL UNIQUE,
    name VARCHAR(255) NOT NULL
);

CREATE TABLE IF NOT EXISTS price (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    station_id BIGINT NOT NULL REFERENCES station(id) ON DELETE CASCADE,
    product_id BIGINT NOT NULL REFERENCES product(id) ON DELETE RESTRICT,
    amount DECIMAL(12,4) NOT NULL,
    effective_at TIMESTAMP NOT NULL
);

CREATE TABLE IF NOT EXISTS sales (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    station_id BIGINT NOT NULL REFERENCES station(id) ON DELETE CASCADE,
    product_id BIGINT NOT NULL REFERENCES product(id) ON DELETE RESTRICT,
    sold_at TIMESTAMP NOT NULL,
    volume DECIMAL(14,3) NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_station_state ON station(state);
CREATE INDEX IF NOT EXISTS idx_price_station_prod_time ON price(station_id, product_id, effective_at);
CREATE INDEX IF NOT EXISTS idx_sales_station_prod_time ON sales(station_id, product_id, sold_at);
